'use strict';var Calc=function(){function b(){}b.range=function(a,c,d,e,f){"clamp"==d&&(a<c.minin&&(a=c.minin),a>c.maxin&&(a=c.maxin));"roll"==d&&(d=c.maxin-c.minin,a=((a-c.minin)%d+d)%d+c.minin);a=(a-c.minin)/(c.maxin-c.minin)*(c.maxout-c.minout)+c.minout;e?a=Math.round(a):f&&(a=parseFloat(a.toFixed(f)));return a};return b}(),FillGauge=function(){function b(a,c){this.min=a;this.max=c;this.color="#FF0000";this.unit="";this.animation=-1;this.init()}b.prototype.dispose=function(){for(;this.html.firstChild;)this.html.removeChild(this.html.lastChild);
this.html=this.unitfield=this.maxfield=this.minfield=this.field=this.fields=this.content=this.content=this.content=null};b.prototype.init=function(){this.html=document.createElement("div");this.html.className="fillgauge";this.content=document.createElement("div");this.content.className="bar";this.fields=document.createElement("div");this.fields.className="value";this.field=document.createElement("span");this.unitfield=document.createElement("span");this.unitfield.className="unit";this.minfield=document.createElement("div");
this.minfield.className="minmax min";this.maxfield=document.createElement("div");this.maxfield.className="minmax max";this.html.appendChild(this.minfield);this.html.appendChild(this.maxfield);this.html.appendChild(this.content);this.fields.appendChild(this.field);this.fields.appendChild(this.unitfield);this.html.appendChild(this.fields);this.minfield.innerHTML=this.min.toString();this.maxfield.innerHTML=this.max.toString();this.unitfield.innerHTML=this.unit};b.prototype.update=function(a){this.field.innerText=
a.toString();var c=Calc.range(a,{minin:this.min,maxin:this.max,minout:0,maxout:100},"clamp",!1,2);this.content.style.height=c+"%";this.lastvalue!=a&&(this.animate(),this.lastvalue=a)};b.prototype.setOptions=function(a,c,d,e){this.min=a?a:this.min;this.max=c?c:this.max;this.color=d?d:this.color;this.unit=e?e:this.unit;this.updateVisual();this.update(isNaN(parseFloat(this.field.innerHTML))?0:parseFloat(this.field.innerHTML))};b.prototype.getHTML=function(){return this.html};b.prototype.updateVisual=
function(){this.content.style.backgroundColor=this.color;this.unitfield.innerHTML=this.unit;this.minfield.innerHTML=this.min.toString();this.maxfield.innerHTML=this.max.toString()};b.prototype.animate=function(){var a=this;-1!=this.animation&&clearTimeout(this.animation);this.content.style.opacity="0.7";this.animation=setTimeout(function(){a.clearAnimation()},3E3)};b.prototype.clearAnimation=function(){clearTimeout(this.animation);this.content.style.opacity="0.4";this.animation=-1};return b}(),GaugeCard=
function(){function b(){this.init()}b.prototype.dispose=function(){ClientEventDispacher.unregister(0,this.onSensorUpdate,this);for(this.content.dispose();this.html.firstChild;)this.html.removeChild(this.html.lastChild);this.subheader=this.header=this.content=null};b.prototype.getHTML=function(){return this.html};b.prototype.setProtocol=function(a){this.protocol=a};b.prototype.setHeader=function(a,c){this.header.innerHTML=a;this.subheader.innerHTML=c};b.prototype.setOptions=function(a,c,d,e){this.content.setOptions(a,
c,d,e)};b.prototype.init=function(){this.html=document.createElement("div");this.html.className="card";this.head=document.createElement("div");this.header=document.createElement("header");this.subheader=document.createElement("header");this.subheader.className="subheader";this.head.appendChild(this.header);this.head.appendChild(this.subheader);this.html.appendChild(this.head);this.content=new FillGauge(15,100);this.html.appendChild(this.content.getHTML());ClientEventDispacher.register(0,this.onSensorUpdate,
this)};b.prototype.onSensorUpdate=function(a){a.protocol==this.protocol&&this.content.update(a.data)};return b}(),DeviceControls=function(){function b(){this.init()}b.prototype.dispose=function(){for(;this.html.firstChild;)this.html.removeChild(this.html.lastChild);this.html=this.autoButton=this.powerButton=null};b.prototype.getHtml=function(){return this.html};b.prototype.setProtocol=function(a){console.log("setproto",a);this.protocol=a;ClientEventDispacher.register(1,this.onDeviceUpdate,this)};
b.prototype.init=function(){this.html=document.createElement("div");this.html.className="devicecontrols";this.powerButton=document.createElement("div");this.powerButton.className="button ripple";this.autoButton=document.createElement("div");this.autoButton.className="button ripple";this.autoButton.onclick=this.onAutoClick.bind(this);this.powerButton.onclick=this.onPowerClick.bind(this);this.html.appendChild(this.powerButton);this.html.appendChild(this.autoButton);this.powerButton.innerHTML="ON";this.autoButton.innerHTML=
"AUTO"};b.prototype.onDeviceUpdate=function(a){a.protocol==this.protocol&&(this.powerButton.innerHTML=a.state,this.autoButton.innerHTML=1==a.auto?"AUTO":"MANUAL")};b.prototype.onAutoClick=function(){COM.out({topic:"deviceUpdate",protocol:this.protocol,payload:"auto"})};b.prototype.onPowerClick=function(){COM.out({topic:"deviceUpdate",protocol:this.protocol,payload:"power"})};return b}(),ControllerCard=function(){function b(){this.init()}b.prototype.dispose=function(){for(;this.html.firstChild;)this.html.removeChild(this.html.lastChild);
this.html=this.field=this.header=this.content=null};b.prototype.getHTML=function(){return this.html};b.prototype.setProtocol=function(a){this.content.setProtocol(a)};b.prototype.setHeader=function(a,c){this.header.innerHTML=a;this.subheader.innerHTML=c};b.prototype.init=function(){this.html=document.createElement("div");this.html.className="card";this.head=document.createElement("div");this.header=document.createElement("header");this.subheader=document.createElement("header");this.subheader.className=
"subheader";this.head.appendChild(this.header);this.head.appendChild(this.subheader);this.html.appendChild(this.head);this.content=new DeviceControls;this.html.appendChild(this.content.getHtml())};return b}(),DefaultView=function(){function b(a){this.root=a}b.prototype.build=function(){for(var a=[{label:"saun",sublabel:"leiliruum",type:1,protocol:"sonoff-saun.DS18B20.Temperature",options:{min:15,max:100,color:"#007800",unit:"\u00b0C"},layout:!1},{label:"saun",sublabel:"puhkeruum",type:1,protocol:"sonoff-saun.AM2301.Temperature",
options:{min:15,max:30,color:"#007800",unit:"\u00b0C"}},{label:"saun",sublabel:"eesruum",type:1,protocol:"sonoff-floorheating-temps.DS18B20-5.Temperature",options:{min:15,max:30,color:"#007800",unit:"\u00b0C"}},{label:"saun",sublabel:"niiskus",type:1,protocol:"sonoff-saun.AM2301.Humidity",options:{min:30,max:100,color:"#005599",unit:"%"}},{label:"vannituba",sublabel:"temperatuur",type:1,protocol:"sonoff-th-wc.AM2301.Temperature",options:{min:15,max:30,color:"#007800",unit:"\u00b0C"}},{label:"vannituba",
sublabel:"niiskus",type:1,protocol:"sonoff-th-wc.AM2301.Humidity",options:{min:30,max:100,color:"#005599",unit:"%"}},{label:"p\u00f5randak\u00fcte",sublabel:"pealevool",type:1,protocol:"sonoff-floorheating-temps.DS18B20-2.Temperature",options:{min:18,max:30,color:"#770099",unit:"\u00b0C"}},{label:"p\u00f5randak\u00fcte",sublabel:"tagasivool",type:1,protocol:"sonoff-floorheating-temps.DS18B20-1.Temperature",options:{min:18,max:30,color:"#770099",unit:"\u00b0C"}},{label:"lisak\u00fcte",sublabel:"pealevool",
type:1,protocol:"sonoff-floorheating-temps.DS18B20-4.Temperature",options:{min:18,max:50,unit:"\u00b0C"}},{label:"lisak\u00fcte",sublabel:"tagasivool",type:1,protocol:"sonoff-floorheating-temps.DS18B20-3.Temperature",options:{min:18,max:50,unit:"\u00b0C"}},{label:"Valgustus",sublabel:"Televiisori taustvalgus",type:2,protocol:"tvbacklight"},{label:"V\u00f5imendi",sublabel:"Puhkeruumi sound",type:2,protocol:"amplifier"}],c=0;c<a.length;c++)switch(a[c].type){case 1:var d=new GaugeCard;d.setHeader(a[c].label,
a[c].sublabel);d.setProtocol(a[c].protocol);d.setOptions(a[c].options.min,a[c].options.max,a[c].options.color,a[c].options.unit);a[c].layout&&(d.getHTML().style.gridColumn=a[c].layout.column,d.getHTML().style.gridRow=a[c].layout.row);this.root.appendChild(d.getHTML());break;case 2:d=new ControllerCard,d.setHeader(a[c].label,a[c].sublabel),d.setProtocol(a[c].protocol),this.root.appendChild(d.getHTML())}};return b}(),Layout=function(){function b(a){this.root=a;this.init()}b.prototype.init=function(){this.view=
new DefaultView(this.root);this.view.build()};return b}(),COM,Communcator=function(){function b(){this.receiver=null}b.prototype.in=function(a){"sensorUpdate"==a.topic&&this.toSensorEvent(a);"deviceUpdate"==a.topic&&(console.log("[COM]in:",a),this.toDeviceEvent(a))};b.prototype.out=function(a){console.log("[COM]out",a);this.receiver?this.receiver(a):console.log("NO RECEIVER")};b.prototype.setReceiver=function(a){this.receiver=a};b.prototype.toSensorEvent=function(a){ClientEventDispacher.dispatch({type:0,
protocol:a.protocol,data:a.payload})};b.prototype.toDeviceEvent=function(a){console.log(a);ClientEventDispacher.dispatch({type:1,protocol:a.protocol,state:a.payload.state,auto:a.payload.auto})};return b}(),ListenerRecord=function(){function b(a){this.dispatching=this.disposed=!1;this.listeners=[];this.scopes=[];this.type=a}b.prototype.dispose=function(){this.disposed=!0;this.scopes=this.listeners=null};b.prototype.add=function(a,c){if(null==a)throw Error("listener can't be null");for(var d=0;d<this.listeners.length;d++)if(this.listeners[d]==
a&&this.scopes[d]==c)return;this.listeners.push(a);this.scopes.push(c)};b.prototype.remove=function(a,c){if(null!=a)for(var d=0;d<this.listeners.length;d++)if(this.listeners[d]==a&&this.scopes[d]==c){1==this.dispatching?(this.listeners[d]=null,this.scopes[d]=null):(this.listeners.splice(d,1),this.scopes.splice(d,1));break}};b.prototype.invoke=function(a){this.dispatching=!0;var c=!1,d;for(d=0;d<this.listeners.length;d++)if(null==this.listeners[d])c=!0;else if(this.listeners[d].call(this.scopes[d],
a),null==this.listeners[d]&&(c=!0),1==this.disposed)return;this.dispatching=!1;if(1==c)for(d=0;d<this.listeners.length;d++)null==this.listeners[d]&&(this.listeners.splice(d,1),this.scopes.splice(d,1),d--)};b.prototype.getType=function(){return this.type};return b}(),ClientEventDispacher,EventBus=function(){function b(){this.listeners=[]}b.prototype.dispose=function(){for(var a=0;a<this.listeners.length;a++)this.listeners[a].dispose()};b.prototype.once=function(a,c,d){};b.prototype.register=function(a,
c,d){var e=this.getHandlerByType(a);null==e&&(e=new ListenerRecord(a),this.listeners.push(e));e.add(c,d)};b.prototype.dispatch=function(a){var c=this.getHandlerByType(a.type);null!=c&&c.invoke(a)};b.prototype.unregister=function(a,c,d){a=this.getHandlerByType(a);null!=a&&a.remove(c,d)};b.prototype.getHandlerByType=function(a){for(var c=0;c<this.listeners.length;c++)if(this.listeners[c].getType()==a)return this.listeners[c];return null};return b}(),Env=function(){function b(){COM=this.communicator=
new Communcator;ClientEventDispacher=new EventBus}b.prototype.layout=function(a){this.display=new Layout(a)};b.prototype.incoming=function(a){COM.in(a)};b.prototype.setReceiver=function(a){COM.setReceiver(a)};return b}();window.env=Env;