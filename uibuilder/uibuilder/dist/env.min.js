'use strict';var __extends=this&&this.__extends||function(){var b=function(a,c){b=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,e){d.__proto__=e}||function(d,e){for(var f in e)Object.prototype.hasOwnProperty.call(e,f)&&(d[f]=e[f])};return b(a,c)};return function(a,c){function d(){this.constructor=a}if("function"!==typeof c&&null!==c)throw new TypeError("Class extends value "+String(c)+" is not a constructor or null");b(a,c);a.prototype=null===c?Object.create(c):(d.prototype=c.prototype,
new d)}}(),BaseCard=function(){function b(){this.init()}b.prototype.dispose=function(){for(;this.html.firstChild;)this.html.removeChild(this.html.lastChild);this.html=this.head=this.icon=null};b.prototype.getHTML=function(){return this.html};b.prototype.setGrowMode=function(a){this.growMode=a};b.prototype.setProtocol=function(a){};b.prototype.setHeader=function(a,c,d){d&&(a=document.createElement("i"),a.className=d,this.icon.appendChild(a))};b.prototype.init=function(){this.large=!1;this.html=document.createElement("div");
this.html.className="card";this.head=document.createElement("div");this.head.className="cardhead";this.icon=document.createElement("div");this.icon.className="cardicon iconcolor";this.head.appendChild(this.icon);this.head.onclick=this.resize.bind(this);this.html.appendChild(this.head)};b.prototype.resize=function(){this.large?(this.large=!1,this.html.classList.remove(this.growMode)):(this.large=!0,this.html.classList.add(this.growMode))};return b}(),Calc=function(){function b(){}b.range=function(a,
c,d,e,f){"clamp"==d&&(a<c.minin&&(a=c.minin),a>c.maxin&&(a=c.maxin));"roll"==d&&(d=c.maxin-c.minin,a=((a-c.minin)%d+d)%d+c.minin);a=(a-c.minin)/(c.maxin-c.minin)*(c.maxout-c.minout)+c.minout;e?a=Math.round(a):f&&(a=parseFloat(a.toFixed(f)));return a};return b}(),FillGauge=function(){function b(a,c){this.min=a;this.max=c;this.color="#FF0000";this.unit="";this.animation=-1;this.init()}b.prototype.dispose=function(){for(;this.html.firstChild;)this.html.removeChild(this.html.lastChild);this.html=this.unitfield=
this.maxfield=this.minfield=this.field=this.fields=this.content=null};b.prototype.init=function(){this.html=document.createElement("div");this.html.className="fillgauge";this.content=document.createElement("div");this.content.className="bar";this.fields=document.createElement("div");this.fields.className="value";this.field=document.createElement("span");this.unitfield=document.createElement("span");this.unitfield.className="unit";this.minfield=document.createElement("div");this.minfield.className=
"minmax min";this.maxfield=document.createElement("div");this.maxfield.className="minmax max";this.html.appendChild(this.minfield);this.html.appendChild(this.maxfield);this.html.appendChild(this.content);this.fields.appendChild(this.field);this.fields.appendChild(this.unitfield);this.html.appendChild(this.fields);this.minfield.innerHTML=this.min.toString();this.maxfield.innerHTML=this.max.toString();this.unitfield.innerHTML=this.unit};b.prototype.update=function(a){this.field.innerText=a.toString();
var c=Calc.range(a,{minin:this.min,maxin:this.max,minout:0,maxout:100},"clamp",!1,2);this.content.style.height=c+"%";this.lastvalue!=a&&(this.animate(),this.lastvalue=a)};b.prototype.setOptions=function(a,c,d,e){this.min=a?a:this.min;this.max=c?c:this.max;this.color=d?d:this.color;this.unit=e?e:this.unit;this.updateVisual();this.update(isNaN(parseFloat(this.field.innerHTML))?0:parseFloat(this.field.innerHTML))};b.prototype.getHTML=function(){return this.html};b.prototype.updateVisual=function(){this.content.style.backgroundColor=
this.color;this.unitfield.innerHTML=this.unit;this.minfield.innerHTML=this.min.toString();this.maxfield.innerHTML=this.max.toString()};b.prototype.animate=function(){var a=this;-1!=this.animation&&clearTimeout(this.animation);this.content.style.opacity="0.7";this.animation=setTimeout(function(){a.clearAnimation()},3E3)};b.prototype.clearAnimation=function(){clearTimeout(this.animation);this.content.style.opacity="0.4";this.animation=-1};return b}(),GaugeCard=function(b){function a(){return null!==
b&&b.apply(this,arguments)||this}__extends(a,b);a.prototype.dispose=function(){ClientEventDispacher.unregister(2,this.onSensorUpdate,this);COM.removeProtocolFilter(this.protocol);this.content.dispose();this.image=this.subheader=this.header=this.content=null;b.prototype.dispose.call(this)};a.prototype.getHTML=function(){return this.html};a.prototype.setProtocol=function(c){this.protocol=c[0];COM.setProtocolFilter(this.protocol)};a.prototype.setHeader=function(c,d,e){b.prototype.setHeader.call(this,
c,d,e);this.header.innerHTML=c;this.subheader.innerHTML=d};a.prototype.setOptions=function(c,d,e,f,g){this.content.setOptions(c,d,e,f);g&&(this.image.style.backgroundImage="url("+g+")")};a.prototype.init=function(){b.prototype.init.call(this);this.image=document.createElement("div");this.image.className="img";this.html.appendChild(this.image);this.header=document.createElement("header");this.subheader=document.createElement("header");this.subheader.className="subheader";this.head.appendChild(this.header);
this.head.appendChild(this.subheader);this.content=new FillGauge(15,100);this.html.appendChild(this.content.getHTML());ClientEventDispacher.register(2,this.onSensorUpdate,this)};a.prototype.onSensorUpdate=function(c){c.protocol==this.protocol&&this.content.update(c.data)};return a}(BaseCard),DeviceControls=function(){function b(a){this.init();this.iconsStateHandler=a}b.prototype.dispose=function(){ClientEventDispacher.unregister(3,this.onDeviceUpdate,this);for(COM.removeProtocolFilter(this.protocol);this.html.firstChild;)this.html.removeChild(this.html.lastChild);
this.html=this.autoButton=this.powerButton=this.updateField=null};b.prototype.getHtml=function(){return this.html};b.prototype.setProtocol=function(a){this.protocol=a[0];COM.setProtocolFilter(this.protocol);ClientEventDispacher.register(3,this.onDeviceUpdate,this)};b.prototype.init=function(){this.html=document.createElement("div");this.html.className="devicecontrols";this.powerButton=document.createElement("div");this.powerButton.className="button ripple";this.autoButton=document.createElement("div");
this.autoButton.className="button ripple";this.updateField=document.createElement("div");this.updateField.className="datefield";this.autoButton.classList.add("hidden");this.autoButton.onclick=this.onAutoClick.bind(this);this.powerButton.onclick=this.onPowerClick.bind(this);this.html.appendChild(this.powerButton);this.html.appendChild(this.autoButton);this.powerButton.innerHTML="ON";this.autoButton.innerHTML="AUTO";this.html.appendChild(this.updateField)};b.prototype.onDeviceUpdate=function(a){a.protocol==
this.protocol&&(this.powerButton.innerHTML=a.state,this.powerButton.classList.remove("on","off"),this.autoButton.classList.remove("auto","manual"),this.powerButton.classList.add(a.state.toLowerCase()),this.updateField.innerHTML="Uuendatud: "+(new Date(a.lastupdate)).toLocaleTimeString(),this.autoButton.innerHTML=1==a.auto?"AUTO":"MANUAL",this.autoButton.classList.add(this.autoButton.innerHTML.toLowerCase()),this.large?this.autoButton.classList.remove("hidden"):this.autoButton.classList.add("hidden"),
this.iconsStateHandler(a.state.toLowerCase()))};b.prototype.onAutoClick=function(){COM.out({topic:"deviceUpdate",protocol:this.protocol,payload:"auto"})};b.prototype.onPowerClick=function(){COM.out({topic:"deviceUpdate",protocol:this.protocol,payload:"power"})};b.prototype.resize=function(a){(this.large=a)?this.autoButton.classList.remove("hidden"):this.autoButton.classList.add("hidden")};return b}(),DeviceCard=function(b){function a(c){var d=b.call(this)||this;d.deviceType=c;return d}__extends(a,
b);a.prototype.dispose=function(){this.content.dispose();this.header=this.content=null;b.prototype.dispose.call(this)};a.prototype.setProtocol=function(c){this.content.setProtocol(c)};a.prototype.setHeader=function(c,d,e){b.prototype.setHeader.call(this,c,d,e);this.header.innerHTML=c;this.subheader.innerHTML=d};a.prototype.iconsState=function(c){0==this.deviceType&&("on"==c?(this.icon.classList.add("bulbshine"),this.icon.classList.remove("iconcolor")):(this.icon.classList.remove("bulbshine"),this.icon.classList.add("iconcolor")));
3==this.deviceType&&("on"==c?(this.icon.classList.add("iconcolor-on"),this.icon.classList.remove("iconcolor")):(this.icon.classList.remove("iconcolor-on"),this.icon.classList.add("iconcolor")));1==this.deviceType&&("on"==c?(this.icon.classList.add("ventrun","rotate"),this.icon.classList.remove("iconcolor")):(this.icon.classList.remove("ventrun","rotate"),this.icon.classList.add("iconcolor")))};a.prototype.init=function(){b.prototype.init.call(this);this.header=document.createElement("header");this.subheader=
document.createElement("header");this.subheader.className="subheader";this.head.appendChild(this.header);this.head.appendChild(this.subheader);this.html.appendChild(this.head);this.content=new DeviceControls(this.iconsState.bind(this));this.html.appendChild(this.content.getHtml())};a.prototype.resize=function(){b.prototype.resize.call(this);this.content.resize(this.large)};return a}(BaseCard),ConnectionStateChart=function(){function b(a){this.protocolList=a}b.prototype.dispose=function(){};b.prototype.getHtml=
function(){return this.html};b.prototype.setProtocol=function(a){var c=this;ClientEventDispacher.register(3,this.onUpdate,this);this.protocolList=a;this.protocolList.forEach(function(d){return c.build(d)})};b.prototype.build=function(a){COM.setProtocolFilter(a)};b.prototype.onUpdate=function(a){this.protocolList.includes(a.protocol)};return b}(),StateIcon=function(){function b(a){this.protocol=a}b.prototype.getProtocol=function(){return this.protocol};b.prototype.getName=function(){if(!this.data)return"";
var a=this.data.name;"Offline"==this.data.status&&(a+=" ... \u00fchenduseta");return a};b.prototype.getStatus=function(){var a;return"Offline"!=(null===(a=this.data)||void 0===a?void 0:a.status)};b.prototype.getValue=function(){var a;return(null===(a=this.data)||void 0===a?void 0:a.RSSI)||0};b.prototype.dispose=function(){this.protocol=this.data=null};b.prototype.update=function(a){this.data=a.data};return b}(),ConnectionStateIcons=function(){function b(){this.current=this.timeout=-1;this.duration=
6E3;this.items=[];this.init()}b.prototype.dispose=function(){var a=this;this.timeout&&clearTimeout(this.timeout);ClientEventDispacher.unregister(4,this.onUpdate,this);for(this.items.forEach(function(c){return a.destroy(c)});this.html.firstChild;)this.html.removeChild(this.html.lastChild);this.html=null};b.prototype.destroy=function(a){COM.removeProtocolFilter(a.getProtocol());a.dispose()};b.prototype.getHtml=function(){return this.html};b.prototype.setProtocol=function(a){var c=this;ClientEventDispacher.register(4,
this.onUpdate,this);this.protocolList=a;this.protocolList.forEach(function(d){return c.build(d)});this.showNext()};b.prototype.init=function(){this.html=document.createElement("div");this.html.className="wifistate";this.icon=document.createElement("i");this.icon.className="fa fa-wifi wifilevelicon";this.html.appendChild(this.icon);this.valueField=document.createElement("span");this.valueField.className="value";this.html.appendChild(this.valueField);this.unitField=document.createElement("span");this.unitField.className=
"unit";this.html.appendChild(this.unitField);this.nameField=document.createElement("span");this.nameField.className="name";this.html.appendChild(this.nameField)};b.prototype.build=function(a){COM.setProtocolFilter(a);a=new StateIcon(a);this.items.push(a)};b.prototype.showNext=function(){this.current++;this.current==this.items.length&&(this.current=0);console.log(this.current);this.show(this.current);var a=this;this.timeout=setTimeout(function(){a.showNext()},this.duration)};b.prototype.show=function(a){var c=
this.items[a].getValue();this.valueField.innerText=c.toString();this.nameField.innerText=this.items[a].getName();this.unitField.innerText="RSSI";this.icon.classList.remove("poor","good","bad");c=20<c?"good":10<c?"poor":"bad";this.items[a].getStatus()||(c="bad");this.icon.classList.add(c)};b.prototype.onUpdate=function(a){this.protocolList.includes(a.protocol)&&(console.log("[CONT] uodate()",a),this.items.find(function(c){return c.getProtocol()==a.protocol}).update(a))};return b}(),ConnectionStateCard=
function(b){function a(){return b.call(this)||this}__extends(a,b);a.prototype.dispose=function(){this.content.dispose();this.header=this.content=null;b.prototype.dispose.call(this)};a.prototype.setProtocol=function(c){this.content.setProtocol(c)};a.prototype.setHeader=function(c,d,e){b.prototype.setHeader.call(this,c,d,e);this.header.innerHTML=c;this.subheader.innerHTML=d};a.prototype.iconsState=function(c){};a.prototype.init=function(){b.prototype.init.call(this);this.header=document.createElement("header");
this.subheader=document.createElement("header");this.subheader.className="subheader";this.head.appendChild(this.header);this.head.appendChild(this.subheader);this.html.appendChild(this.head);this.content=new ConnectionStateIcons;this.html.appendChild(this.content.getHtml())};a.prototype.resize=function(){b.prototype.resize.call(this)};return a}(BaseCard),DefaultView=function(){function b(a){this.root=a}b.prototype.build=function(){for(var a=[{label:"saun",sublabel:"leiliruum",icon:"fa fa-thermometer",
type:1,grow:"large",protocol:["sonoff-saun.DS18B20.Temperature"],options:{min:15,max:100,color:"#007800",unit:"\u00b0C",image:"images/saun.jpg"},layout:!1},{label:"saun",sublabel:"eesruum",icon:"fa fa-thermometer",type:1,grow:"large",protocol:["sonoff-floorheating-temps.DS18B20-5.Temperature"],options:{min:15,max:30,color:"#007800",unit:"\u00b0C",image:"images/eesruum.jpg"}},{label:"saun",sublabel:"niiskus",icon:"fa fa-tint",type:1,grow:"large",protocol:["sonoff-saun.AM2301.Humidity"],options:{min:30,
max:100,color:"#005599",unit:"%",image:"images/niiskus.jpg"}},{label:"vannituba",sublabel:"temperatuur",icon:"fa fa-thermometer",type:1,grow:"large",protocol:["sonoff-th-wc.AM2301.Temperature"],options:{min:15,max:30,color:"#007800",unit:"\u00b0C",image:"images/vannituba.jpg"}},{label:"vannituba",sublabel:"niiskus",icon:"fa fa-tint",type:1,grow:"large",protocol:["sonoff-th-wc.AM2301.Humidity"],options:{min:30,max:100,color:"#005599",unit:"%",image:"images/vannituba-niiskus.jpg"}},{label:"p\u00f5randak\u00fcte",
sublabel:"pealevool",icon:"fa fa-thermometer",type:1,grow:"large",protocol:["sonoff-floorheating-temps.DS18B20-2.Temperature"],options:{min:18,max:30,color:"#770099",unit:"\u00b0C",image:"images/pk-pealevool.jpg"}},{label:"p\u00f5randak\u00fcte",sublabel:"tagasivool",icon:"fa fa-thermometer",type:1,grow:"large",protocol:["sonoff-floorheating-temps.DS18B20-1.Temperature"],options:{min:18,max:30,color:"#770099",unit:"\u00b0C",image:"images/pk-tagasivool.jpg"}},{label:"lisak\u00fcte",sublabel:"pealevool",
icon:"fa fa-thermometer",type:1,grow:"large",protocol:["sonoff-floorheating-temps.DS18B20-4.Temperature"],options:{min:18,max:50,unit:"\u00b0C",image:"images/lisa-peale.jpg"}},{label:"lisak\u00fcte",sublabel:"tagasivool",icon:"fa fa-thermometer",type:1,grow:"large",protocol:["sonoff-floorheating-temps.DS18B20-3.Temperature"],options:{min:18,max:50,unit:"\u00b0C",image:"images/lisa-tagasi.jpg"}},{label:"Taustvalgus",sublabel:"Televiisori taustvalgus",icon:"fa fa-lightbulb-o",type:2,grow:"wide",deviceType:0,
protocol:["tvbacklight"]},{label:"V\u00f5imendi",sublabel:"Puhkeruumi sound",icon:"fa fa-music",type:2,grow:"wide",deviceType:3,protocol:["amplifier"]},{label:"Mini ventilaatorid",sublabel:"Puhkeruumi \u00f5huringlus",icon:"fa fa-crosshairs",type:2,grow:"wide",deviceType:1,protocol:["minivent"]},{label:"Ventilaator",sublabel:"V\u00e4ljat\u00f5mbe ventilaator",icon:"fa fa-crosshairs",type:2,grow:"wide",deviceType:1,protocol:["vent"]},{label:"K\u00f6\u00f6gi t\u00f6\u00f6valgus",sublabel:"T\u00f6\u00f6pinna valgusti",
icon:"fa fa-lightbulb-o",type:2,grow:"wide",deviceType:0,protocol:["kitchenworklight"]},{label:"K\u00f6\u00f6gi \u00f5htuvalgus",sublabel:"Meeleolu valgustid",icon:"fa fa-lightbulb-o",type:2,grow:"wide",deviceType:0,protocol:["kitchentoplight"]},{label:"Voodi \u00f5htuvalgus",sublabel:"Meeleolu valgustid",icon:"fa fa-lightbulb-o",type:2,grow:"wide",deviceType:0,protocol:["bedunderlight"]},{label:"WIFI",sublabel:"Seadmete \u00fchendus",icon:"fa fa-wifi",type:3,grow:"large",protocol:"sonoff-amp.connection sonoff-backlight.connection sonoff-bed.connection sonoff-extraheat.connection sonoff-floorheating-temps.connection sonoff-kitchen-shelf.connection sonoff-saun.connection sonoff-socket.connection sonoff-tempreg.connection sonoff-th-wc.connection sonoff-pesumasin.connection".split(" ")}],
c=0;c<a.length;c++){var d=void 0,e=a[c];switch(e.type){case 1:d=new GaugeCard;d.setOptions(e.options.min,e.options.max,e.options.color,e.options.unit,e.options.image);break;case 2:d=new DeviceCard(e.deviceType);break;case 3:d=new ConnectionStateCard}d.setHeader(e.label,e.sublabel,e.icon);d.setProtocol(e.protocol);d.setGrowMode(e.grow);e.layout&&(d.getHTML().style.gridColumn=e.layout.column,d.getHTML().style.gridRow=e.layout.row);this.root.appendChild(d.getHTML())}};return b}(),Layout=function(){function b(a){this.root=
a;this.onConnectionLost();this.init()}b.prototype.init=function(){ClientEventDispacher.register(0,this.onConnection,this);ClientEventDispacher.register(1,this.onConnectionLost,this);this.view=new DefaultView(this.root);this.view.build()};b.prototype.onConnection=function(){this.root.style.filter="unset"};b.prototype.onConnectionLost=function(){this.root.style.filter="sepia(100%) blur(1px)"};return b}(),COM,Communcator=function(){function b(){this.receiver=null;this.protocolfilter=["node-red.protocol"]}
b.prototype.connection=function(a){(this.connected=a)?ClientEventDispacher.dispatch({type:0}):ClientEventDispacher.dispatch({type:1})};b.prototype.setProtocolFilter=function(a){this.protocolfilter.includes(a)||this.protocolfilter.push(a)};b.prototype.removeProtocolFilter=function(a){a=this.protocolfilter.indexOf(a,0);-1<a&&this.protocolfilter.splice(a,1)};b.prototype.in=function(a){a.protocol&&this.protocolfilter.includes(a.protocol)&&("protocolFilter"==a.topic?this.out({topic:"protocolFilter",protocol:"node-red.protocol",
payload:this.protocolfilter}):"sensorUpdate"==a.topic?this.toSensorEvent(a):"deviceUpdate"==a.topic?this.toDeviceEvent(a):"controllerConnection"==a.topic&&this.toControllerConnectionEvent(a))};b.prototype.out=function(a){this.connected?this.receiver?this.receiver(a):console.log("NO RECEIVER"):console.log("[COM] no connection")};b.prototype.setReceiver=function(a){this.receiver=a};b.prototype.toSensorEvent=function(a){ClientEventDispacher.dispatch({type:2,protocol:a.protocol,data:a.payload})};b.prototype.toDeviceEvent=
function(a){ClientEventDispacher.dispatch({type:3,protocol:a.protocol,state:a.payload.state,auto:a.payload.auto,lastupdate:a.payload.lastupdate})};b.prototype.toControllerConnectionEvent=function(a){ClientEventDispacher.dispatch({type:4,protocol:a.protocol,data:a.payload})};return b}(),ListenerRecord=function(){function b(a){this.dispatching=this.disposed=!1;this.listeners=[];this.scopes=[];this.type=a}b.prototype.dispose=function(){this.disposed=!0;this.scopes=this.listeners=null};b.prototype.add=
function(a,c){if(null==a)throw Error("listener can't be null");for(var d=0;d<this.listeners.length;d++)if(this.listeners[d]==a&&this.scopes[d]==c)return;this.listeners.push(a);this.scopes.push(c)};b.prototype.remove=function(a,c){if(null!=a)for(var d=0;d<this.listeners.length;d++)if(this.listeners[d]==a&&this.scopes[d]==c){1==this.dispatching?(this.listeners[d]=null,this.scopes[d]=null):(this.listeners.splice(d,1),this.scopes.splice(d,1));break}};b.prototype.invoke=function(a){this.dispatching=!0;
var c=!1,d;for(d=0;d<this.listeners.length;d++)if(null==this.listeners[d])c=!0;else if(this.listeners[d].call(this.scopes[d],a),null==this.listeners[d]&&(c=!0),1==this.disposed)return;this.dispatching=!1;if(1==c)for(d=0;d<this.listeners.length;d++)null==this.listeners[d]&&(this.listeners.splice(d,1),this.scopes.splice(d,1),d--)};b.prototype.getType=function(){return this.type};return b}(),ClientEventDispacher,EventBus=function(){function b(){this.listeners=[]}b.prototype.dispose=function(){for(var a=
0;a<this.listeners.length;a++)this.listeners[a].dispose()};b.prototype.once=function(a,c,d){};b.prototype.register=function(a,c,d){var e=this.getHandlerByType(a);null==e&&(e=new ListenerRecord(a),this.listeners.push(e));e.add(c,d)};b.prototype.dispatch=function(a){var c=this.getHandlerByType(a.type);null!=c&&c.invoke(a)};b.prototype.unregister=function(a,c,d){a=this.getHandlerByType(a);null!=a&&a.remove(c,d)};b.prototype.getHandlerByType=function(a){for(var c=0;c<this.listeners.length;c++)if(this.listeners[c].getType()==
a)return this.listeners[c];return null};return b}(),Env=function(){function b(){COM=this.communicator=new Communcator;ClientEventDispacher=new EventBus}b.prototype.layout=function(a){this.display=new Layout(a)};b.prototype.incoming=function(a){COM.in(a)};b.prototype.connection=function(a){COM.connection(a)};b.prototype.setReceiver=function(a){COM.setReceiver(a)};return b}();window.env=Env;